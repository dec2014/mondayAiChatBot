# -*- coding: utf-8 -*-
"""Untitled8.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1XFIvrb0gM8VYwqyKMCdbGE_wATI1rgP1
"""

import streamlit as st
import requests
import openai

# ---------------- CONFIG ----------------
MONDAY_API_KEY = "eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjYyNTU4MzIzMCwiYWFpIjoxMSwidWlkIjoxMDAyODQyNzgsImlhZCI6IjIwMjYtMDItMjVUMDU6NDI6MjguMTg5WiIsInBlciI6Im1lOndyaXRlIiwiYWN0aWQiOjMzOTYwMzM5LCJyZ24iOiJhcHNlMiJ9.amcaIqOXKQzGNoEY8Tafd8pRlJjQ8bBvwW9UoEaYc6E"

OPENAI_API_KEY = "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"

openai.api_key = OPENAI_API_KEY
MONDAY_URL = "https://api.monday.com/v2"

BOARD_IDS = [5026839123, 5026839113]  # Work Order + Deal Funnel
# ---------------------------------------


def format_selected_boards(data):
    DEFAULTS = {
        "Status": "Pending",
        "Owner": "Unassigned",
        "Due Date": "No deadline",
        "Priority": "Normal",
        "Stage": "Early stage",
        "Deal Value": "Value not finalized"
    }

    text = ""

    for board in data["data"]["boards"]:
        text += f"\nBoard: {board['name']}\n"
        text += "-" * 40 + "\n"

        for item in board["items_page"]["items"]:
            text += f"Task: {item['name']}\n"

            for col in item["column_values"]:
                title = col["column"]["title"]
                value = col["text"]

                if value and value.strip():
                    text += f"{title}: {value}\n"
                elif title in DEFAULTS:
                    text += f"{title}: {DEFAULTS[title]}\n"

            text += "\n"

    return text


def fetch_latest_context():
    query = f"""
    {{
      boards(ids: {BOARD_IDS}) {{
        name
        items_page(limit: 50) {{
          items {{
            name
            column_values {{
              text
              column {{ title }}
            }}
          }}
        }}
      }}
    }}
    """

    headers = {
        "Authorization": MONDAY_API_KEY,
        "Content-Type": "application/json"
    }

    r = requests.post(MONDAY_URL, json={"query": query}, headers=headers)
    return format_selected_boards(r.json())


def ask_chatbot(question, context):
    prompt = f"""
You are an assistant that answers questions using ONLY the data below.

DATA:
{context}

QUESTION:
{question}

ANSWER:
"""

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.2
    )

    return response.choices[0].message.content


# ---------------- STREAMLIT UI ----------------
st.set_page_config(page_title="Monday AI Chatbot", layout="centered")

st.title("ðŸ¤– monday.com AI Chatbot")
st.caption("Live data â€¢ Auto-updated â€¢ Board-aware")

question = st.text_input("Ask a question about work orders or deals:")

if question:
    with st.spinner("Fetching latest data..."):
        context_data = fetch_latest_context()

    with st.spinner("Thinking..."):
        answer = ask_chatbot(question, context_data)

    st.success("Answer")
    st.write(answer)
